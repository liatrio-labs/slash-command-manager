name: Run tests and linting

on:
  # Avoid duplicate runs: run on PRs for branches, and on direct pushes to main
  # but ignore changes to pyproject.toml, CHANGELOG.md, uv.lock, and build artifacts
  # This is to avoid running tests and linting for commits that only relate to releases
  push:
    branches: ["main"]
    paths-ignore:
    - "pyproject.toml"
    - "CHANGELOG.md"
    - "uv.lock"
    - "slash_commands/_git_commit.py"
  pull_request:

jobs:
  test:
    name: Test (uv + pytest)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        python: ["3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv (with cache)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Install Python
        run: uv python install ${{ matrix.python }}

      - name: Sync dependencies (frozen)
        run: uv sync --all-groups --extra dev --frozen

      - name: Run tests with coverage
        run: uv run pytest -vv --cov=mcp_server --cov=slash_commands --cov-report=term-missing:skip-covered --cov-report=xml


      - name: Upload coverage.xml artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml-${{ matrix.python }}
          path: coverage.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          flags: unittests
          fail_ci_if_error: false

  lint:
    name: Lint (uv + ruff)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv (with cache)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Install Python
        run: uv python install 3.12

      - name: Sync dependencies (frozen)
        run: uv sync --all-groups --extra dev --frozen

      - name: Run ruff lint
        run: uv run ruff check .

      - name: Format (check)
        run: uv run ruff format --check .

      - name: Pre-commit (meta checks)
        run: uv run pre-commit run --all-files --show-diff-on-failure

  build:
    name: Build (verify package builds)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv (with cache)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Install Python
        run: uv python install 3.12

      - name: Sync dependencies (frozen)
        run: uv sync --all-groups --extra dev --frozen

      - name: Verify uv.lock is up to date
        run: |
          # Check if lock file needs updating (without actually updating it)
          uv lock --check || {
            echo "❌ uv.lock is out of sync with pyproject.toml"
            echo "Run 'uv lock' locally and commit the updated uv.lock file"
            exit 1
          }
          echo "✅ uv.lock is up to date"

      - name: Build package
        run: |
          # Build wheel and source distribution to verify package builds correctly
          uv run python -m build --wheel --sdist
          echo "✅ Package built successfully"
          # List built artifacts
          ls -lh dist/

      - name: Verify built package
        run: |
          # Verify the wheel can be inspected and contains expected files
          uv run python - <<'PY'
          import zipfile
          import glob
          wheels = glob.glob('dist/*.whl')
          if not wheels:
              raise Exception('No wheel file found')
          wheel = wheels[0]
          print(f'✅ Found wheel: {wheel}')
          with zipfile.ZipFile(wheel) as z:
              files = sorted(z.namelist())
              print(f'✅ Wheel contains {len(files)} files')
              # Verify key files/directories are present
              # Directories use startswith, files check root or nested paths
              required_dirs = ['slash_commands/', 'mcp_server/']
              required_files = ['server.py']
              for req in required_dirs:
                  if any(f.startswith(req) for f in files):
                      print(f'✅ Contains {req}')
                  else:
                      raise Exception(f'Missing required directory: {req}')
              for req in required_files:
                  # Check for exact match at root OR nested path (e.g., path/server.py)
                  if any(f == req or f.endswith(f'/{req}') for f in files):
                      print(f'✅ Contains {req}')
                  else:
                      raise Exception(f'Missing required file: {req}')
          PY

  help-test:
    name: Help Test (verify CLI help output)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv (with cache)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Install Python
        run: uv python install 3.12

      - name: Sync dependencies (frozen)
        run: uv sync --all-groups --extra dev --frozen

      - name: Test main command help
        run: uv run slash-man --help

      - name: Test generate subcommand help
        run: uv run slash-man generate --help

      - name: Test cleanup subcommand help
        run: uv run slash-man cleanup --help

  integration-test:
    name: Integration Tests (Docker)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t slash-man-test .

      - name: Run integration tests
        run: docker run --rm --entrypoint="" slash-man-test sh -c "cd /app && uv run pytest tests/integration/ -v -m integration"

  dev-release:
    name: Dev Release (Test PyPI)
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' && vars.RUN_DEV_RELEASE_JOBS == 'true' }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install uv (with cache)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock

      - name: Install Python
        run: uv python install 3.12

      - name: Sync dependencies (frozen)
        run: uv sync --all-groups --extra dev --frozen

      - name: Install python-semantic-release
        run: uv pip install --system "python-semantic-release>=10.0.0,<11.0.0"

      - name: Install build package
        run: uv pip install --system build

      - name: Generate dev version
        id: dev-version
        run: |
          VERSION=$(semantic-release -c .releaserc.toml version --as-prerelease --prerelease-token dev --build-metadata ${{ github.sha }} --no-push --no-vcs-release --no-commit --no-tag --print)
          echo "Generated version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify version was generated
        run: |
          VERSION="${{ steps.dev-version.outputs.version }}"
          SHA_SHORT="${{ github.sha }}"
          SHA_SHORT="${SHA_SHORT:0:7}"
          if [[ ! "$VERSION" =~ dev ]] || [[ ! "$VERSION" =~ $SHA_SHORT ]]; then
            echo "❌ Version verification failed: $VERSION"
            echo "Expected version to contain 'dev' and SHA prefix '$SHA_SHORT'"
            exit 1
          fi
          echo "✅ Version verified: $VERSION"

      - name: Build package
        run: uv run python -m build --wheel --sdist

      - name: Verify build artifacts
        run: |
          echo "Build artifacts:"
          ls -lh dist/
          if [ -z "$(ls -A dist/*.whl 2>/dev/null)" ] || [ -z "$(ls -A dist/*.tar.gz 2>/dev/null)" ]; then
            echo "❌ Build artifacts missing!"
            exit 1
          fi
          echo "✅ Build artifacts verified"

      - name: Publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@v1.13.0
        with:
          pypi-url: https://test.pypi.org/legacy/
          packages-dir: dist/
